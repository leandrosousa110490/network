<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Data Dashboard (Standalone)</title>
    
    <!-- Libraries (CDN) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/gridstack@7.2.3/dist/gridstack-all.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
    /* INJECTED CSS */
    /* {{STYLE_CSS}} */
    
    /* Adjustments for standalone */
    /* Hide File Loading and SQL Transform sections */
    /* We'll do this via JS to be more precise, or generic CSS if we can identify them */
    
    .sidebar-toggle-area, .sidebar {
        display: none !important; /* Hide sidebar in standalone mode as file ops aren't supported */
    }
    .main-content {
        margin-left: 0 !important;
    }
    
    .toolbar button.btn-save {
        display: none; /* Hide export button in exported file */
    }
    
    /* Hide Widget Controls in Standalone Mode */
    .grid-stack-item-content:hover .widget-controls {
        display: none !important;
    }
    
    /* Also disable resize handles */
    .ui-resizable-handle {
        display: none !important;
    }
    
    /* Seamless Background Theme */
    body, .main-content, .grid-container {
        background-color: #ffffff !important; /* Match widget default white */
    }
    
    /* Remove Widget Borders/Shadows for seamless look */
    .grid-stack-item-content {
        box-shadow: none !important;
        border: 1px solid #e0e0e0 !important; /* Subtle border to "see the boxes" as requested */
        background-color: #ffffff !important;
    }
    
    /* If user wants "blends in nicely", maybe no border? 
       But "so you can see the boxes" implies visibility.
       Let's keep the subtle border but remove strong shadows/bg differences.
    */
    </style>
</head>
<body>
    <div class="d-flex h-100">
        <!-- Sidebar Toggle Area (Hover Trigger) -->
        <div class="sidebar-toggle-area">
            <button class="btn btn-sm btn-primary rounded-circle sidebar-toggle-btn" onclick="toggleSidebar()" title="Expand Sidebar">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- Sidebar -->
        <div class="sidebar p-3 bg-dark text-white" id="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="m-0">Data Dashboard</h4>
                <button class="btn btn-sm btn-outline-light border-0" onclick="toggleSidebar()" title="Minimize Sidebar">
                    <i class="fas fa-minus"></i>
                </button>
            </div>
            <hr>
            
            <!-- Dashboard Name -->
            <div class="mb-4">
                <label class="form-label text-muted small">DASHBOARD SETTINGS</label>
                <input type="text" class="form-control bg-dark text-white border-secondary" id="dashboardNameInput" placeholder="Enter dashboard name...">
            </div>

            <!-- File Loading (HIDDEN) -->
            <div class="mb-4 d-none">
                <label class="form-label text-muted small">DATA SOURCE</label>
                <button class="btn btn-outline-light w-100 mb-2" onclick="browseFile()">
                    <i class="fas fa-folder-open me-2"></i>Load File
                </button>
                <div id="fileInfo" class="small text-info mb-2"></div>
            </div>

            <!-- Data Operations (HIDDEN) -->
            <div class="mb-4 d-none">
                <label class="form-label text-muted small">DATA OPERATIONS</label>
                <button class="btn btn-outline-light w-100 mb-2" onclick="showSqlModal()">
                    <i class="fas fa-database me-2"></i>Transform Data
                </button>
            </div>

            <!-- Add Chart -->
            <div class="mb-4">
                <label class="form-label text-muted small">VISUALIZATIONS</label>
                <div class="viz-grid">
                    <div class="viz-item" onclick="showAddChartModal('bar')">
                        <i class="fas fa-chart-bar"></i>
                        <span>Bar Chart</span>
                    </div>
                    <div class="viz-item" onclick="showAddChartModal('line')">
                        <i class="fas fa-chart-line"></i>
                        <span>Line Chart</span>
                    </div>
                    <div class="viz-item" onclick="showAddChartModal('pie')">
                        <i class="fas fa-chart-pie"></i>
                        <span>Pie Chart</span>
                    </div>
                    <div class="viz-item" onclick="showAddChartModal('scatter')">
                        <i class="fas fa-braille"></i>
                        <span>Scatter</span>
                    </div>
                    <div class="viz-item" onclick="showAddChartModal('table')">
                        <i class="fas fa-table"></i>
                        <span>Table</span>
                    </div>
                    <div class="viz-item" onclick="showAddChartModal('text')">
                        <i class="fas fa-font"></i>
                        <span>Text</span>
                    </div>
                </div>
            </div>

            <!-- Global Filters -->
            <div class="mb-4">
                <label class="form-label text-muted small">FILTERS</label>
                <div id="filtersContainer">
                    <!-- <p class="text-muted small fst-italic">Load data to add filters</p> -->
                </div>
                <button class="btn btn-sm btn-outline-secondary mt-2 w-100" onclick="addFilter()" id="addFilterBtn">
                    <i class="fas fa-filter me-1"></i> Add Filter
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content flex-grow-1 bg-light">
            <div class="container-fluid h-100 d-flex flex-column">
                <!-- Toolbar -->
                <div class="toolbar py-2 px-3 bg-white border-bottom d-flex align-items-center" id="topHeader">
                    <div id="titleContainer" class="w-100">
                         <span id="dashboardTitle" class="fw-bold fs-4"></span>
                    </div>
                </div>

                <!-- Grid Area -->
                <div class="grid-container flex-grow-1 p-3 overflow-auto">
                    <div class="grid-stack"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Chart Modal -->
    <div class="modal fade" id="addChartModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Chart</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Select Values -->
                    <div class="mb-3">
                        <label class="form-label">Chart Type</label>
                        <select class="form-select" id="chartType" onchange="toggleChartSettings()">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="scatter">Scatter Plot</option>
                            <option value="table">Table</option>
                            <option value="text">Text / Note</option>
                        </select>
                    </div>
                    
                    <!-- Chart Specific Settings -->
                    <div id="chartSettings">
                        <div class="mb-3">
                            <label class="form-label">X Axis (Category)</label>
                            <select class="form-select column-select" id="xAxis"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date Grouping (Optional)</label>
                            <select class="form-select" id="timeGroup">
                                <option value="">None (Raw Values)</option>
                                <option value="day">Day</option>
                                <option value="month">Month and Year</option>
                                <option value="year">Just Year</option>
                            </select>
                            <div class="form-text text-muted small">Only applies if X Axis is a date column</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Y Axis (Value)</label>
                            <div class="form-text text-muted small mb-1">Hold Ctrl/Cmd to select multiple</div>
                            <select class="form-select column-select" id="yAxis" multiple size="3"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Aggregation</label>
                            <select class="form-select" id="aggregation">
                                <option value="count">Count</option>
                                <option value="sum">Sum</option>
                                <option value="avg">Average</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Legend (Group By)</label>
                            <select class="form-select column-select" id="legendCol">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="showValues">
                            <label class="form-check-label" for="showValues">Show Values on Chart</label>
                        </div>
                    </div>

                    <!-- Table Specific Settings -->
                    <div id="tableSettings" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Columns to Display</label>
                            <div class="form-text text-muted small mb-1">Hold Ctrl/Cmd to select multiple</div>
                            <select class="form-select column-select" id="tableColumns" multiple size="8"></select>
                        </div>
                    </div>

                    <!-- Text Widget Settings -->
                    <div id="textSettings" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Content</label>
                            <textarea class="form-control" id="textContent" rows="4" placeholder="Enter your text here..."></textarea>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Font Size</label>
                                <select class="form-select" id="textSize">
                                    <option value="1rem">Normal</option>
                                    <option value="1.25rem">Medium</option>
                                    <option value="1.5rem">Large</option>
                                    <option value="2rem">Extra Large</option>
                                    <option value="3rem">Huge</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Alignment</label>
                                <select class="form-select" id="textAlign">
                                    <option value="left">Left</option>
                                    <option value="center">Center</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Style</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="textBold">
                                    <label class="form-check-label" for="textBold">Bold</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="textItalic">
                                    <label class="form-check-label" for="textItalic">Italic</label>
                                </div>
                            </div>
                        </div>
                         <div class="mb-3">
                            <label class="form-label">Text Color</label>
                            <input type="color" class="form-control form-control-color w-100" id="textColor" value="#212529" title="Choose your color">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Title (Optional)</label>
                        <input type="text" class="form-control" id="chartTitle" placeholder="Leave empty for no title">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveChartWidget()">Add Widget</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Filter Modal (Required for editing filters) -->
    <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Filter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Column</label>
                        <select class="form-select" id="filterColumn" onchange="updateFilterValues()"></select>
                    </div>

                    <!-- Display Style -->
                    <div class="mb-3">
                        <label class="form-label">Display Style</label>
                        <div class="d-flex gap-3 flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="filterDisplayStyle" id="displayDropdown" value="dropdown" checked onchange="toggleListOrientationOption()">
                                <label class="form-check-label" for="displayDropdown">
                                    <i class="fas fa-caret-square-down me-1"></i> Dropdown
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="filterDisplayStyle" id="displayList" value="list" onchange="toggleListOrientationOption()">
                                <label class="form-check-label" for="displayList">
                                    <i class="fas fa-list-ul me-1"></i> List (All Values)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- List Orientation Option -->
                    <div class="mb-3" id="listOrientationOption" style="display: none;">
                        <label class="form-label">List Orientation</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="filterListOrientation" id="orientVertical" value="vertical" checked>
                                <label class="form-check-label" for="orientVertical">
                                    <i class="fas fa-arrows-alt-v me-1"></i> Vertical
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="filterListOrientation" id="orientHorizontal" value="horizontal">
                                <label class="form-check-label" for="orientHorizontal">
                                    <i class="fas fa-arrows-alt-h me-1"></i> Horizontal
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Select Values</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start text-truncate" type="button" id="filterValuesDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                                Select values...
                            </button>
                            <div class="dropdown-menu w-100 p-2" aria-labelledby="filterValuesDropdown" id="filterValues" style="max-height: 300px; overflow-y: auto;">
                                <div class="text-muted small text-center p-2">Select a column first</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveFilter()">Apply Filter</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // INJECTED DATA
        window.DASHBOARD_DATA = "{{DATA_JSON}}";
        window.INITIAL_DASHBOARD_STATE = "{{STATE_JSON}}";
        
        // Handle Title Display
        try {
            const state = typeof window.INITIAL_DASHBOARD_STATE === 'string' 
                ? JSON.parse(window.INITIAL_DASHBOARD_STATE) 
                : window.INITIAL_DASHBOARD_STATE;
                
            if (state && state.dashboardTitle) {
                document.getElementById('dashboardTitle').innerText = state.dashboardTitle;
                
                // Handle Alignment
                const align = state.dashboardTitleAlign || 'left';
                const container = document.getElementById('titleContainer');
                container.className = 'w-100'; // reset
                if (align === 'center') container.classList.add('text-center');
                else if (align === 'right') container.classList.add('text-end');
                else container.classList.add('text-start');
                
            } else {
                document.getElementById('topHeader').style.display = 'none';
            }
        } catch (e) {
             document.getElementById('topHeader').style.display = 'none';
        }

        // EEL SHIM
        window.eel = {
            get_startup_file: () => { return async () => null; },
            load_file: (path, type) => { return async () => ({success: true, columns: Object.keys(window.DASHBOARD_DATA[0] || {}), row_count: window.DASHBOARD_DATA.length}); },
            get_unique_values: (col) => { return async () => window.MiniEngine.getUniqueValues(col); },
            get_chart_data: (config, filters) => { return async () => window.MiniEngine.getChartData(config, filters); },
            
            // Mock other unused functions
            browse_file: () => { return async () => ({success: false, error: "Not supported in standalone mode"}); },
            transform_data: () => { return async () => ({success: false, error: "Not supported in standalone mode"}); }
        };
    </script>

    <script>
    /* MINI ENGINE JS */
    /* {{MINI_ENGINE_JS}} */
    </script>

    <script>
    /* ORIGINAL SCRIPT JS */
    /* {{SCRIPT_JS}} */
    </script>

    <script>
    // Initialization Script
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Mini Engine with Data
        if (window.MiniEngine && window.DASHBOARD_DATA) {
             try {
                let data = window.DASHBOARD_DATA;
                // Parse if string, otherwise use as is (if injected as object)
                if (typeof data === 'string') {
                    data = JSON.parse(data);
                    window.DASHBOARD_DATA = data;
                }
                
                if (Array.isArray(data)) {
                    window.MiniEngine.init(data);
                } else {
                    console.error("Dashboard data is not an array");
                }
             } catch (e) {
                 console.error("Failed to parse dashboard data", e);
             }
        }

        // Restore State
        if (window.INITIAL_DASHBOARD_STATE) {
            try {
                let state = window.INITIAL_DASHBOARD_STATE;
                if (typeof state === 'string') {
                    state = JSON.parse(state);
                }
                
                // Normalize State Columns to match Data Columns (Case Insensitive Fix)
                if (window.DASHBOARD_DATA && window.DASHBOARD_DATA.length > 0 && window.MiniEngine) {
                    
                    // Use MiniEngine to get robust list of columns
                    const actualCols = window.MiniEngine.getColumns();
                    dashboardState.columns = actualCols; // Update global columns immediately
                    
                    const matchCol = (colName) => {
                        return window.MiniEngine.resolveCol(colName);
                    };
                    
                    // Update Widgets
                    if (state.widgets) {
                        Object.values(state.widgets).forEach(w => {
                            if (w.x) w.x = matchCol(w.x);
                            if (w.legend) w.legend = matchCol(w.legend);
                            if (w.y) {
                                if (Array.isArray(w.y)) w.y = w.y.map(matchCol);
                                else w.y = matchCol(w.y);
                            }
                            if (w.columns) w.columns = w.columns.map(matchCol);
                            if (w.type === 'filter' && w.column) w.column = matchCol(w.column);
                        });
                    }
                    
                    // Update Filters
                    if (state.filters) {
                        const newFilters = {};
                        Object.entries(state.filters).forEach(([k, v]) => {
                            newFilters[matchCol(k)] = v;
                        });
                        state.filters = newFilters;
                    }
                }
                
                // Overwrite global dashboardState (defined in script.js)
                Object.assign(dashboardState, state);
                
                // Ensure file loaded flag is set
                dashboardState.fileLoaded = true;
                // Ensure columns are set (redundant but safe)
                if (!dashboardState.columns || dashboardState.columns.length === 0) {
                     dashboardState.columns = window.MiniEngine ? window.MiniEngine.getColumns() : Object.keys(window.DASHBOARD_DATA[0] || {});
                }
                
                // Wait for grid to be ready (script.js initializes it)
                setTimeout(() => {
                    if (grid) {
                        grid.removeAll();
                        // Restore widgets
                        if (dashboardState.widgets) {
                            Object.values(dashboardState.widgets).forEach(config => {
                                // Fix for layout vs column conflict in restore
                                // Ensure we use gs_x/y for layout if available
                                const restoreConfig = {...config};
                                // If this is a new export with gs_ vars, restoreWidget will handle it (in script.js if updated, or here if we override)
                                // Since we cannot easily update the injected script.js without re-injecting,
                                // we must monkey-patch or handle it here.
                                
                                // But wait, script.js is injected above. I can override restoreWidget function?
                                // No, restoreWidget is defined in script.js.
                                
                                // Actually, I should pass the correct layout x/y to restoreWidget if it expects x/y for layout.
                                // But config.x/y might be columns now!
                                
                                // If I updated script.js (which I did), then restoreWidget in script.js will handle gs_x/y.
                                // So I just need to make sure I call it with the config that has gs_x/y.
                                restoreWidget(restoreConfig);
                            });
                        }
                        // Refresh to load data
                        refreshAllWidgets();
                        
                        // UI Check for Data
                        if (!window.MiniEngine.data || window.MiniEngine.data.length === 0) {
                            const msg = document.createElement('div');
                            msg.className = 'alert alert-warning m-3';
                            msg.innerHTML = '<strong>Warning:</strong> No data loaded in export. Charts may be empty.';
                            document.querySelector('.grid-container').prepend(msg);
                        }
                    }
                }, 500);
            } catch (e) {
                console.error("Failed to restore dashboard state", e);
            }
        }
    });
    </script>
</body>
</html>
